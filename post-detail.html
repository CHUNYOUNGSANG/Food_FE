<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ìƒì„¸ - ë§›ì§‘ê³µìœ </title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/post-detail.css">
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="header-logo">
                <span class="header-logo-icon">ğŸ½ï¸</span>
                <span>ë§›ì§‘ê³µìœ </span>
            </a>
            
            <nav class="header-nav">
                <a href="index.html" class="header-nav-link">í™ˆ</a>
                <a href="post-list.html" class="header-nav-link">ê²Œì‹œíŒ</a>
                <a href="post-create.html" class="header-btn-primary header-btn">ë§›ì§‘ ê³µìœ í•˜ê¸°</a>
            </nav>
            
            <div class="header-user" id="headerUser">
                <div id="authButtons">
                    <button class="header-btn" onclick="location.href='login.html'">ë¡œê·¸ì¸</button>
                </div>
                <div id="userInfo" class="hidden">
                    <div class="header-user-info" onclick="location.href='profile.html'">
                        <div class="header-user-avatar" id="userAvatar">U</div>
                        <span class="header-user-name" id="userName">ì‚¬ìš©ì</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ê²Œì‹œê¸€ ìƒì„¸ -->
    <main class="post-detail-page">
        <div class="post-detail-container">
            <!-- ë¡œë”© -->
            <div id="loading" class="posts-loading">
                <div class="loading"></div>
                <p>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
            <div id="postContent" class="hidden">
                <!-- í—¤ë” -->
                <div class="post-header">
                    <span class="post-category-badge" id="postCategory">í•œì‹</span>
                    <h1 class="post-title" id="postTitle">ê²Œì‹œê¸€ ì œëª©</h1>
                    <div class="post-meta">
                        <div class="post-author">
                            <div class="post-author-avatar" id="authorAvatar">U</div>
                            <div class="post-author-info">
                                <div class="post-author-name" id="authorName">ì‘ì„±ì</div>
                                <div class="post-author-date" id="postDate">2024-01-01</div>
                            </div>
                        </div>
                        <div class="post-stats">
                            <span class="post-stat">ğŸ‘ï¸ <span id="viewCount">0</span></span>
                            <span class="post-stat">â¤ï¸ <span id="likeCount">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- ë§›ì§‘ ì •ë³´ -->
                <div class="restaurant-info">
                    <h2 class="restaurant-name" id="restaurantName">ë§›ì§‘ ì´ë¦„</h2>
                    <div class="restaurant-details">
                        <div class="restaurant-detail">
                            ğŸ“ <span id="restaurantAddress">ì£¼ì†Œ</span>
                        </div>
                        <div class="restaurant-rating">
                            <span class="restaurant-rating-stars" id="ratingStars">â­â­â­â­â­</span>
                            <span class="restaurant-rating-value" id="ratingValue">5.0</span>
                        </div>
                    </div>
                </div>

                <!-- ê²Œì‹œê¸€ ì´ë¯¸ì§€ -->
                <div class="post-image-container" id="imageContainer" style="display: none;">
                    <img src="" alt="ë§›ì§‘ ì´ë¯¸ì§€" class="post-image" id="postImage">
                </div>

                <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
                <div class="post-content">
                    <div class="post-content-text" id="postContentText"></div>
                </div>

                <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                <div class="post-actions">
                    <button class="post-like-btn" id="likeBtn">
                        <span>â¤ï¸</span>
                        <span>ì¢‹ì•„ìš”</span>
                        <span id="likeBtnCount">0</span>
                    </button>
                    <div class="post-edit-actions" id="editActions" style="display: none;">
                        <button class="post-edit-btn" id="editBtn">ìˆ˜ì •</button>
                        <button class="post-delete-btn" id="deleteBtn">ì‚­ì œ</button>
                    </div>
                </div>

                <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
                <section class="comments-section">
                    <h2 class="comments-header">
                        ëŒ“ê¸€ <span id="commentCount">0</span>
                    </h2>

                    <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                    <form class="comment-form" id="commentForm">
                        <textarea 
                            class="comment-textarea" 
                            id="commentContent"
                            placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”..."
                            rows="3"></textarea>
                        <button type="submit" class="comment-submit-btn">ëŒ“ê¸€ ì‘ì„±</button>
                    </form>

                    <!-- ëŒ“ê¸€ ëª©ë¡ -->
                    <div class="comments-list" id="commentsList">
                        <!-- ë™ì  ìƒì„± -->
                    </div>

                    <!-- ë¹ˆ ìƒíƒœ -->
                    <div class="comments-empty hidden" id="commentsEmpty">
                        <div class="comments-empty-icon">ğŸ’¬</div>
                        <h3>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script type="module">
        import { getPost, getComments, createComment, deleteComment, togglePostLike, getPostLikeCount } from './js/api/api.js';
        
        let currentPost = null;
        let currentMemberId = null;

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            initUser();
            await loadPost();
            initEventListeners();
        });

        // ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”
        function initUser() {
            currentMemberId = localStorage.getItem('memberId');
            const memberNickname = localStorage.getItem('memberNickname');
            
            if (currentMemberId && memberNickname) {
                document.getElementById('authButtons').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userName').textContent = memberNickname;
                document.getElementById('userAvatar').textContent = memberNickname[0].toUpperCase();
            }
        }

        // ê²Œì‹œê¸€ ë¡œë“œ
        async function loadPost() {
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');
            
            if (!postId) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return;
            }

            try {
                currentPost = await getPost(postId);
                renderPost(currentPost);
                await loadComments(postId);
                await loadLikeStatus(postId);
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = 'index.html';
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('postContent').classList.remove('hidden');
            }
        }

        // ê²Œì‹œê¸€ ë Œë”ë§
        function renderPost(post) {
            document.getElementById('postCategory').textContent = post.foodCategory || 'ê¸°íƒ€';
            document.getElementById('postTitle').textContent = post.title;
            document.getElementById('authorName').textContent = post.memberNickname;
            document.getElementById('authorAvatar').textContent = (post.memberNickname || 'U')[0].toUpperCase();
            document.getElementById('postDate').textContent = formatDate(post.createdAt);
            document.getElementById('viewCount').textContent = post.viewCount || 0;
            
            document.getElementById('restaurantName').textContent = post.restaurantName || 'ì •ë³´ ì—†ìŒ';
            document.getElementById('restaurantAddress').textContent = post.restaurantAddress || 'ì •ë³´ ì—†ìŒ';
            
            const stars = 'â­'.repeat(Math.floor(post.rating || 0));
            document.getElementById('ratingStars').textContent = stars;
            document.getElementById('ratingValue').textContent = (post.rating || 0).toFixed(1);
            
            if (post.imageUrl) {
                document.getElementById('imageContainer').style.display = 'block';
                document.getElementById('postImage').src = post.imageUrl;
            }
            
            document.getElementById('postContentText').textContent = post.content;
            
            // ì‘ì„±ì ë³¸ì¸ì´ë©´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
            if (currentMemberId && currentMemberId == post.memberId) {
                document.getElementById('editActions').style.display = 'flex';
            }
        }

        // ëŒ“ê¸€ ë¡œë“œ
        async function loadComments(postId) {
            try {
                const comments = await getComments(postId);
                const commentsList = Array.isArray(comments) ? comments : [];
                
                document.getElementById('commentCount').textContent = commentsList.length;
                
                if (commentsList.length === 0) {
                    document.getElementById('commentsEmpty').classList.remove('hidden');
                    document.getElementById('commentsList').innerHTML = '';
                } else {
                    document.getElementById('commentsEmpty').classList.add('hidden');
                    renderComments(commentsList);
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ëŒ“ê¸€ ë Œë”ë§
        function renderComments(comments) {
            const html = comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-header">
                        <div class="comment-author">
                            <div class="comment-author-avatar">
                                ${(comment.memberNickname || 'U')[0].toUpperCase()}
                            </div>
                            <div>
                                <div class="comment-author-name">${comment.memberNickname || 'ìµëª…'}</div>
                                <div class="comment-date">${formatDate(comment.createdAt)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="comment-actions">
                        ${currentMemberId && currentMemberId == comment.memberId ? 
                            `<button class="comment-delete-btn" onclick="deleteCommentHandler(${comment.id})">ì‚­ì œ</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('commentsList').innerHTML = html;
        }

        // ì¢‹ì•„ìš” ìƒíƒœ ë¡œë“œ
        async function loadLikeStatus(postId) {
            try {
                const likeData = await getPostLikeCount(postId);
                document.getElementById('likeCount').textContent = likeData.likeCount || 0;
                document.getElementById('likeBtnCount').textContent = likeData.likeCount || 0;
                
                if (likeData.isLiked) {
                    document.getElementById('likeBtn').classList.add('liked');
                }
            } catch (error) {
                console.error('ì¢‹ì•„ìš” ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        function initEventListeners() {
            // ëŒ“ê¸€ ì‘ì„±
            document.getElementById('commentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!currentMemberId) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = 'login.html';
                    return;
                }
                
                const content = document.getElementById('commentContent').value.trim();
                if (!content) {
                    alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                
                try {
                    await createComment(currentPost.id, { content });
                    document.getElementById('commentContent').value = '';
                    await loadComments(currentPost.id);
                } catch (error) {
                    console.error('ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨:', error);
                    alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });

            // ì¢‹ì•„ìš”
            document.getElementById('likeBtn').addEventListener('click', async () => {
                if (!currentMemberId) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = 'login.html';
                    return;
                }
                
                try {
                    await togglePostLike(currentPost.id);
                    await loadLikeStatus(currentPost.id);
                } catch (error) {
                    console.error('ì¢‹ì•„ìš” ì‹¤íŒ¨:', error);
                }
            });

            // ìˆ˜ì •
            document.getElementById('editBtn').addEventListener('click', () => {
                window.location.href = `post-edit.html?id=${currentPost.id}`;
            });

            // ì‚­ì œ
            document.getElementById('deleteBtn').addEventListener('click', async () => {
                if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                
                try {
                    await deletePost(currentPost.id);
                    alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        // ëŒ“ê¸€ ì‚­ì œ (ì „ì—­ í•¨ìˆ˜)
        window.deleteCommentHandler = async (commentId) => {
            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await deleteComment(currentPost.id, commentId);
                await loadComments(currentPost.id);
            } catch (error) {
                console.error('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ë‚ ì§œ í¬ë§·
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'ë°©ê¸ˆ ì „';
            if (minutes < 60) return `${minutes}ë¶„ ì „`;
            if (hours < 24) return `${hours}ì‹œê°„ ì „`;
            if (days < 7) return `${days}ì¼ ì „`;
            
            return date.toLocaleDateString('ko-KR');
        }
    </script>
</body>
</html>