<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§›ì§‘ ê³µìœ í•˜ê¸° - ë§›ì§‘ê³µìœ </title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/post-form.css">
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="header-logo">
                <span class="header-logo-icon">ğŸ½ï¸</span>
                <span>ë§›ì§‘ê³µìœ </span>
            </a>
            
            <nav class="header-nav">
                <a href="index.html" class="header-nav-link">í™ˆ</a>
                <a href="post-list.html" class="header-nav-link">ê²Œì‹œíŒ</a>
            </nav>
            
            <div class="header-user" id="headerUser"></div>
        </div>
    </header>

    <!-- ê²Œì‹œê¸€ ì‘ì„± í¼ -->
    <main class="post-form-page">
        <div class="post-form-container">
            <div class="post-form-header">
                <h1 class="post-form-title">ğŸ´ ë§›ì§‘ ê³µìœ í•˜ê¸°</h1>
                <p class="post-form-subtitle">ë‹¹ì‹ ì˜ íŠ¹ë³„í•œ ë§›ì§‘ ê²½í—˜ì„ ê³µìœ í•´ì£¼ì„¸ìš”</p>
            </div>

            <form class="post-form" id="postForm">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="form-section">
                    <h2 class="form-section-title">ğŸ“ ê¸°ë³¸ ì •ë³´</h2>
                    
                    <div class="form-group form-group-full">
                        <label for="title" class="form-label">ì œëª© *</label>
                        <input 
                            type="text" 
                            id="title" 
                            class="form-input" 
                            placeholder="ë§›ì§‘ í›„ê¸° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                            maxlength="100"
                            required>
                    </div>

                    <div class="form-group form-group-full">
                        <label for="content" class="form-label">ë‚´ìš© *</label>
                        <textarea 
                            id="content" 
                            class="form-input post-form-textarea" 
                            placeholder="ë§›ì§‘ì— ëŒ€í•œ ìì„¸í•œ í›„ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”&#10;&#10;- ë°©ë¬¸ ë‚ ì§œì™€ ì‹œê°„ëŒ€&#10;- ì£¼ë¬¸í•œ ë©”ë‰´&#10;- ë§›ê³¼ ì„œë¹„ìŠ¤ í‰ê°€&#10;- íŠ¹ë³„í•œ ê²½í—˜ì´ë‚˜ íŒ"
                            required></textarea>
                    </div>
                </div>

                <!-- ë§›ì§‘ ì •ë³´ -->
                <div class="form-section">
                    <h2 class="form-section-title">ğŸª ë§›ì§‘ ì •ë³´</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="restaurantName" class="form-label">ë§›ì§‘ ì´ë¦„</label>
                            <input 
                                type="text" 
                                id="restaurantName" 
                                class="form-input" 
                                placeholder="ë§›ì§‘ ì´ë¦„">
                        </div>

                        <div class="form-group">
                            <label for="foodCategory" class="form-label">ì¹´í…Œê³ ë¦¬ *</label>
                            <select id="foodCategory" class="form-input" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="í•œì‹">ğŸš í•œì‹</option>
                                <option value="ì¤‘ì‹">ğŸ¥Ÿ ì¤‘ì‹</option>
                                <option value="ì¼ì‹">ğŸ± ì¼ì‹</option>
                                <option value="ì–‘ì‹">ğŸ ì–‘ì‹</option>
                                <option value="ì¹´í˜">â˜• ì¹´í˜</option>
                                <option value="ë””ì €íŠ¸">ğŸ° ë””ì €íŠ¸</option>
                                <option value="ê¸°íƒ€">ğŸ½ï¸ ê¸°íƒ€</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group form-group-full">
                        <label for="restaurantAddress" class="form-label">ì£¼ì†Œ</label>
                        <input 
                            type="text" 
                            id="restaurantAddress" 
                            class="form-input" 
                            placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">í‰ì  *</label>
                        <div class="rating-input">
                            <div class="rating-stars" id="ratingStars">
                                <span class="rating-star" data-value="1">â­</span>
                                <span class="rating-star" data-value="2">â­</span>
                                <span class="rating-star" data-value="3">â­</span>
                                <span class="rating-star" data-value="4">â­</span>
                                <span class="rating-star" data-value="5">â­</span>
                            </div>
                            <span class="rating-value" id="ratingValue">0.0</span>
                        </div>
                        <input type="hidden" id="rating" value="0" required>
                    </div>
                </div>

                <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                <div class="form-section">
                    <h2 class="form-section-title">ğŸ“· ì‚¬ì§„ ì¶”ê°€</h2>
                    
                    <div class="form-group">
                        <label class="form-label">ëŒ€í‘œ ì´ë¯¸ì§€</label>
                        <div class="image-upload-area" id="imageUploadArea">
                            <div class="image-upload-icon">ğŸ“¸</div>
                            <div class="image-upload-text">
                                <p>í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                                <p style="font-size: 12px; color: #999; margin-top: 8px;">
                                    JPG, PNG (ìµœëŒ€ 5MB)
                                </p>
                            </div>
                            <input 
                                type="file" 
                                id="imageFile" 
                                accept="image/*"
                                style="display: none;">
                        </div>
                        <div class="image-preview" id="imagePreview">
                            <img src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="image-preview-img" id="previewImg">
                        </div>
                        <input type="hidden" id="imageUrl">
                    </div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="form-actions">
                    <button type="button" class="form-btn-cancel" onclick="history.back()">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="form-btn-submit" id="submitBtn">
                        ê³µìœ í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script type="module">
        import { createPost } from './js/api/api.js';
        
        let selectedRating = 0;
        let uploadedImageUrl = '';

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            initRating();
            initImageUpload();
            initForm();
        });

        // ë¡œê·¸ì¸ ì²´í¬
        function checkLogin() {
            const memberId = localStorage.getItem('memberId');
            if (!memberId) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                window.location.href = 'login.html';
            }
        }

        // í‰ì  ì„ íƒ
        function initRating() {
            const stars = document.querySelectorAll('.rating-star');
            
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.dataset.value);
                    document.getElementById('rating').value = selectedRating;
                    document.getElementById('ratingValue').textContent = selectedRating.toFixed(1);
                    
                    stars.forEach(s => {
                        const value = parseInt(s.dataset.value);
                        if (value <= selectedRating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });

                star.addEventListener('mouseenter', () => {
                    const value = parseInt(star.dataset.value);
                    stars.forEach(s => {
                        if (parseInt(s.dataset.value) <= value) {
                            s.style.opacity = '1';
                        } else {
                            s.style.opacity = '0.3';
                        }
                    });
                });
            });

            document.getElementById('ratingStars').addEventListener('mouseleave', () => {
                stars.forEach(s => {
                    const value = parseInt(s.dataset.value);
                    if (value <= selectedRating) {
                        s.style.opacity = '1';
                    } else {
                        s.style.opacity = '0.3';
                    }
                });
            });
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        function initImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const fileInput = document.getElementById('imageFile');
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');

            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImg.src = e.target.result;
                        preview.classList.add('show');
                        
                        // ì‹¤ì œë¡œëŠ” ì„œë²„ì— ì—…ë¡œë“œí•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” base64ë¡œ ì €ì¥
                        uploadedImageUrl = e.target.result;
                        document.getElementById('imageUrl').value = uploadedImageUrl;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // í¼ ì œì¶œ
        function initForm() {
            document.getElementById('postForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                if (selectedRating === 0) {
                    alert('í‰ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'ê³µìœ í•˜ëŠ” ì¤‘...';

                const postData = {
                    title: document.getElementById('title').value,
                    content: document.getElementById('content').value,
                    restaurantName: document.getElementById('restaurantName').value || 'ì •ë³´ ì—†ìŒ',
                    restaurantAddress: document.getElementById('restaurantAddress').value,
                    foodCategory: document.getElementById('foodCategory').value,
                    rating: selectedRating,
                    imageUrl: uploadedImageUrl || null
                };

                try {
                    const result = await createPost(postData);
                    alert('ë§›ì§‘ì´ ì„±ê³µì ìœ¼ë¡œ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                    window.location.href = `post-detail.html?id=${result.id}`;
                } catch (error) {
                    console.error('ê²Œì‹œê¸€ ì‘ì„± ì‹¤íŒ¨:', error);
                    alert('ê²Œì‹œê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê³µìœ í•˜ê¸°';
                }
            });
        }
    </script>
</body>
</html>